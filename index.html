<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投資売買シミュレーター</title>
    <!-- Tailwind CSS CDNを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwindの設定：カスタムカラーとフォントを設定
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans JP', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'primary-dark': '#4338ca',
                        'success': '#10b981',
                        'danger': '#ef4444',
                        'bg-light': '#f9fafb',
                    }
                }
            }
        }
    </script>
    <style>
        /* スクロールバーの非表示（モバイルフレンドリー） */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6; /* わずかに暗い背景 */
        }
        /* スタイリングの微調整 */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
            text-align: center; 
        }
    </style>
</head>
<body class="p-3 sm:p-4 md:p-6">

    <div class="max-w-4xl mx-auto">

        <!-- ヘッダーとトグルボタン -->
        <header class="mb-4 space-y-4">
            <h1 class="text-3xl font-extrabold text-gray-800 text-center">難平計算</h1>

            <!-- ショート/ロング トグルボタン -->
            <div id="typeToggle" class="flex p-1 bg-white rounded-lg shadow-md w-full max-w-sm mx-auto cursor-pointer">
                <div id="longBtn" data-type="long" class="flex-1 text-center py-2 px-4 rounded-md font-semibold transition-all duration-300 text-white bg-primary shadow-sm">
                    ロング (買い)
                </div>
                <div id="shortBtn" data-type="short" class="flex-1 text-center py-2 px-4 rounded-md font-semibold transition-all duration-300 text-gray-500 hover:bg-bg-light">
                    ショート (売り)
                </div>
            </div>
        </header>

        <!-- サマリー表示エリア -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
            <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-primary">
                <p class="text-sm font-medium text-gray-500">平均単価</p>
                <p id="avgPriceDisplay" class="text-2xl font-bold text-gray-800 mt-1">--</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-primary">
                <p class="text-sm font-medium text-gray-500">合計数量</p>
                <p id="totalQuantityDisplay" class="text-2xl font-bold text-gray-800 mt-1">--</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-md border-l-4 border-primary">
                <p class="text-sm font-medium text-gray-500">合計金額</p>
                <p id="totalValueDisplay" class="text-2xl font-bold text-gray-800 mt-1">--</p>
            </div>
        </div>
        
        <!-- 利確目標と損益エリア -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">利確目標シミュレーション</h2>
            <div class="flex flex-col sm:flex-row items-center gap-4">
                <div class="flex-1 w-full">
                    <label for="targetPrice" class="block text-sm font-medium text-gray-700 mb-1">利確予定価格</label>
                    <input type="number" id="targetPrice" oninput="calculateProfitLoss()" placeholder="価格を入力"
                           class="w-full py-2 px-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                </div>
                <div class="flex-1 w-full mt-2 sm:mt-0">
                    <p class="text-sm font-medium text-gray-500 mb-1">想定損益 (P&L)</p>
                    <p id="profitLossDisplay" class="text-2xl font-bold mt-1 text-gray-800">--</p>
                </div>
            </div>
        </div>


        <!-- 取引入力テーブル -->
        <div class="bg-white p-4 rounded-lg shadow-md">
            <div id="transactionTable">
                <!-- テーブルヘッダー (PC/タブレット用) -->
                <div class="hidden sm:grid grid-cols-12 gap-2 text-sm font-semibold text-gray-600 border-b pb-2 mb-3">
                    <div class="col-span-4 text-center">価格</div>
                    <div class="col-span-4 text-center">数量 (100単位)</div>
                    <div class="col-span-3 text-right">合計金額</div>
                    <div class="col-span-1"></div> <!-- 削除ボタン用 -->
                </div>

                <!-- 取引行がここに追加される -->
                <div id="transactionsContainer" class="space-y-3">
                    <!-- 初期行はJavaScriptで追加 -->
                </div>
            </div>

            <!-- 行追加ボタン -->
            <button id="addRowBtn" class="w-full mt-4 py-2 px-4 bg-bg-light text-primary font-semibold rounded-lg border border-primary-dark/20 hover:bg-primary/10 transition duration-150 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                行を追加
            </button>
        </div>

    </div>

    <script>
        // グローバル変数と初期設定
        let transactions = [];
        let isLong = true; // true: ロング (買い), false: ショート (売り)
        const quantityStep = 100;

        // ====================================================================
        // I. DOM要素の取得
        // ====================================================================
        const container = document.getElementById('transactionsContainer');
        const addRowBtn = document.getElementById('addRowBtn');
        const avgPriceDisplay = document.getElementById('avgPriceDisplay');
        const totalQuantityDisplay = document.getElementById('totalQuantityDisplay');
        const totalValueDisplay = document.getElementById('totalValueDisplay');
        const targetPriceInput = document.getElementById('targetPrice');
        const profitLossDisplay = document.getElementById('profitLossDisplay');
        const longBtn = document.getElementById('longBtn');
        const shortBtn = document.getElementById('shortBtn');

        // ====================================================================
        // II. コアロジック関数
        // ====================================================================

        /**
         * すべての取引を再計算し、サマリー表示を更新する
         */
        function updateSummary() {
            let totalValue = 0;
            let totalQuantity = 0;

            // 1. 各行の合計金額を計算し、合計を集計
            transactions.forEach((transaction, index) => {
                const price = parseFloat(transaction.price);
                const quantity = parseFloat(transaction.quantity);
                
                // 有効な数値であることを確認
                if (isNaN(price) || isNaN(quantity)) return;

                const rowTotal = price * quantity;
                totalValue += rowTotal;
                totalQuantity += quantity;

                // 各行の合計金額表示を更新
                const rowTotalElement = document.getElementById(`total-${index}`);
                if (rowTotalElement) {
                    rowTotalElement.textContent = formatCurrency(rowTotal);
                }
            });

            // 2. 平均単価を計算
            const avgPrice = totalQuantity > 0 ? totalValue / totalQuantity : 0;

            // 3. サマリー表示の更新
            avgPriceDisplay.textContent = formatCurrency(avgPrice);
            totalQuantityDisplay.textContent = formatQuantity(totalQuantity);
            totalValueDisplay.textContent = formatCurrency(totalValue);

            // 4. 損益計算も同時に実行
            calculateProfitLoss();
        }

        /**
         * 利確予定価格に基づき損益を計算し、表示を更新する
         */
        function calculateProfitLoss() {
            const targetPrice = parseFloat(targetPriceInput.value);
            let totalValue = 0;
            let totalQuantity = 0;

            transactions.forEach(t => {
                const price = parseFloat(t.price);
                const quantity = parseFloat(t.quantity);
                if (!isNaN(price) && !isNaN(quantity)) {
                    totalValue += price * quantity;
                    totalQuantity += quantity;
                }
            });

            if (isNaN(targetPrice) || totalQuantity === 0) {
                profitLossDisplay.textContent = '--';
                profitLossDisplay.className = 'text-2xl font-bold mt-1 text-gray-800';
                return;
            }

            // P&L = (決済価格 - 平均単価) × 合計数量
            const avgPrice = totalValue / totalQuantity;
            let profitLoss;
            
            if (isLong) {
                // ロング (買い): (売却価格 - 平均単価) * 数量
                profitLoss = (targetPrice - avgPrice) * totalQuantity;
            } else {
                // ショート (売り): (平均単価 - 買戻し価格) * 数量
                profitLoss = (avgPrice - targetPrice) * totalQuantity;
            }

            // 損益表示の更新
            const displayValue = formatCurrency(profitLoss);
            profitLossDisplay.textContent = displayValue;

            // 色付け (プラス:緑, マイナス:赤, ゼロ:黒)
            let colorClass;
            if (profitLoss > 0.001) {
                colorClass = 'text-success';
            } else if (profitLoss < -0.001) {
                colorClass = 'text-danger';
            } else {
                colorClass = 'text-gray-800';
            }
            profitLossDisplay.className = `text-2xl font-bold mt-1 ${colorClass}`;
        }

        // ====================================================================
        // III. DOM操作関数
        // ====================================================================

        /**
         * 新しい取引行のHTML要素を作成する
         * @param {number} index - 取引のインデックス
         * @returns {string} - HTML文字列
         */
        function createTransactionRow(index) {
            const transaction = transactions[index];
            
            // モバイルとPCで異なるレイアウトを適用 (sm:grid)
            return `
                <div id="row-${index}" class="bg-bg-light p-3 rounded-lg shadow-sm sm:grid sm:grid-cols-12 sm:gap-2 items-center border-b border-gray-200 last:border-b-0">
                    
                    <!-- 1. 価格入力＆ボタン (col-span-4) -->
                    <div class="sm:col-span-4 mb-3 sm:mb-0">
                        <label for="price-${index}" class="block text-xs font-medium text-gray-500 sm:hidden mb-1">価格</label>
                        <div class="flex items-stretch space-x-1">
                            <!-- 価格マイナスボタン: ラベルの垂直位置を調整するために-mt-0.5を追加 -->
                            <button onclick="changePrice(${index}, -1)" class="w-10 h-10 flex items-center justify-center bg-danger text-white text-2xl font-bold rounded-l-lg hover:bg-danger/80 transition duration-150" aria-label="価格を減らす"><span class="-mt-0.5">-</span></button>
                            <!-- 入力欄のパディングを py-2 に調整 -->
                            <input type="number" id="price-${index}" value="${transaction.price}" oninput="handleInputChange(${index}, 'price', this.value)" placeholder="価格" step="any"
                                   class="flex-1 py-2 text-center border-y border-gray-300 focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary">
                            <!-- ボタンサイズを w-10 h-10 に拡大 -->
                            <button onclick="changePrice(${index}, 1)" class="w-10 h-10 flex items-center justify-center bg-success text-white text-2xl font-bold rounded-r-lg hover:bg-success/80 transition duration-150" aria-label="価格を増やす">+</button>
                        </div>
                    </div>

                    <!-- 2. 数量入力＆ボタン (col-span-4) -->
                    <div class="sm:col-span-4 mb-3 sm:mb-0">
                        <label for="quantity-${index}" class="block text-xs font-medium text-gray-500 sm:hidden mb-1">数量 (100単位)</label>
                        <div class="flex items-stretch space-x-1">
                            <!-- 数量マイナスボタン: ラベルの垂直位置を調整するために-mt-0.5を追加 -->
                            <button onclick="changeQuantity(${index}, -${quantityStep})" class="w-10 h-10 flex items-center justify-center bg-gray-500 text-white text-2xl font-bold rounded-l-lg hover:bg-gray-600 transition duration-150" aria-label="数量を100減らす"><span class="-mt-0.5">-</span></button>
                            <!-- 入力欄のパディングを py-2 に調整 -->
                            <input type="number" id="quantity-${index}" value="${transaction.quantity}" oninput="handleInputChange(${index}, 'quantity', this.value)" placeholder="数量" step="${quantityStep}"
                                   class="flex-1 py-2 text-center border-y border-gray-300 focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary">
                            <!-- ボタンサイズを w-10 h-10 に拡大し、記号を + に変更 -->
                            <button onclick="changeQuantity(${index}, ${quantityStep})" class="w-10 h-10 flex items-center justify-center bg-gray-500 text-white text-2xl font-bold rounded-r-lg hover:bg-gray-600 transition duration-150" aria-label="数量を100増やす">+</button>
                        </div>
                    </div>

                    <!-- 3. 合計金額 (col-span-3) -->
                    <div class="sm:col-span-3 mb-3 sm:mb-0">
                        <p class="text-sm font-medium text-gray-700 sm:text-right">合計金額:</p>
                        <p id="total-${index}" class="text-lg font-bold text-gray-800 sm:text-right mt-1 sm:mt-0">--</p>
                    </div>

                    <!-- 4. 削除ボタン (col-span-1) -->
                    <div class="sm:col-span-1 flex justify-center sm:justify-end">
                        <button onclick="removeRow(${index})" class="w-8 h-8 text-danger hover:bg-danger/10 rounded-full flex items-center justify-center transition duration-150" aria-label="この行を削除">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }
        
        /**
         * 指定されたインデックスの取引行を削除し、再描画する
         * @param {number} indexToRemove - 削除する取引のインデックス
         */
        function removeRow(indexToRemove) {
            // 対象の行を削除
            transactions.splice(indexToRemove, 1);
            
            // DOMから要素を削除
            const rowElement = document.getElementById(`row-${indexToRemove}`);
            if (rowElement) {
                rowElement.remove();
            }

            // 残りの行を再描画してインデックスを修正
            renderTransactions();
            updateSummary();
        }

        /**
         * 全ての取引行をコンテナに描画する
         */
        function renderTransactions() {
            container.innerHTML = ''; // コンテナをクリア
            transactions.forEach((_, index) => {
                container.insertAdjacentHTML('beforeend', createTransactionRow(index));
            });
            updateSummary(); // 描画後に必ずサマリーを更新
        }

        /**
         * 新しい取引行を追加する
         */
        function addRow() {
            const newIndex = transactions.length;
            transactions.push({ price: 0, quantity: 0 });
            container.insertAdjacentHTML('beforeend', createTransactionRow(newIndex));
            // 新しい行がビューに入るようにスクロール
            document.getElementById(`row-${newIndex}`).scrollIntoView({ behavior: 'smooth', block: 'end' });
            updateSummary();
        }

        // ====================================================================
        // IV. イベントハンドラ
        // ====================================================================

        /**
         * 入力フィールドが変更されたときの処理
         * @param {number} index - 取引のインデックス
         * @param {string} field - 変更されたフィールド ('price' または 'quantity')
         * @param {string} value - 新しい値
         */
        function handleInputChange(index, field, value) {
            // NaNの場合は0に設定
            const numericValue = parseFloat(value);
            transactions[index][field] = isNaN(numericValue) ? 0 : numericValue;
            updateSummary();
        }

        /**
         * 価格増減ボタンの処理
         * @param {number} index - 取引のインデックス
         * @param {number} delta - 変更量 (通常 +1 または -1)
         */
        function changePrice(index, delta) {
            const currentPrice = parseFloat(transactions[index].price);
            const newPrice = Math.max(0, currentPrice + delta); // 価格は0未満にならない
            transactions[index].price = newPrice.toFixed(2); // 小数点第2位まで保持
            document.getElementById(`price-${index}`).value = newPrice.toFixed(2);
            updateSummary();
        }

        /**
         * 数量増減ボタンの処理
         * @param {number} index - 取引のインデックス
         * @param {number} delta - 変更量 (+100 または -100)
         */
        function changeQuantity(index, delta) {
            const currentQuantity = parseFloat(transactions[index].quantity);
            const newQuantity = Math.max(0, currentQuantity + delta); // 数量は0未満にならない
            transactions[index].quantity = newQuantity;
            document.getElementById(`quantity-${index}`).value = newQuantity;
            updateSummary();
        }
        
        /**
         * ショート/ロングのトグル状態を切り替える
         * @param {boolean} isNewLong - 新しい状態 (true:ロング, false:ショート)
         */
        function toggleType(isNewLong) {
            if (isLong === isNewLong) return; // 変更がない場合は何もしない

            isLong = isNewLong;

            if (isLong) {
                // ロングに切り替え
                longBtn.classList.add('bg-primary', 'text-white', 'shadow-sm');
                longBtn.classList.remove('text-gray-500', 'hover:bg-bg-light');
                shortBtn.classList.remove('bg-primary', 'text-white', 'shadow-sm');
                shortBtn.classList.add('text-gray-500', 'hover:bg-bg-light');
                longBtn.textContent = 'ロング (買い)';
                shortBtn.textContent = 'ショート (売り)';
            } else {
                // ショートに切り替え
                shortBtn.classList.add('bg-primary', 'text-white', 'shadow-sm');
                shortBtn.classList.remove('text-gray-500', 'hover:bg-bg-light');
                longBtn.classList.remove('bg-primary', 'text-white', 'shadow-sm');
                longBtn.classList.add('text-gray-500', 'hover:bg-bg-light');
                longBtn.textContent = 'ロング (決済)';
                shortBtn.textContent = 'ショート (新規)';
            }
            calculateProfitLoss(); // トグル後、P&Lを再計算
        }


        // ====================================================================
        // V. ユーティリティ関数
        // ====================================================================
        
        /**
         * 通貨形式にフォーマットする
         * @param {number} number - フォーマットする数値
         * @returns {string} - フォーマットされた文字列
         */
        function formatCurrency(number) {
            if (isNaN(number)) return '--';
            const sign = number < 0 ? '-' : '';
            const absNumber = Math.abs(number);
            return sign + absNumber.toLocaleString('ja-JP', { minimumFractionDigits: 2, maximumFractionDigits: 4 });
        }

        /**
         * 数量形式にフォーマットする
         * @param {number} number - フォーマットする数値
         * @returns {string} - フォーマットされた文字列
         */
        function formatQuantity(number) {
            if (isNaN(number)) return '--';
            return number.toLocaleString('ja-JP', { maximumFractionDigits: 0 });
        }


        // ====================================================================
        // VI. 初期化とイベントリスナー設定
        // ====================================================================
        
        function init() {
            // デフォルトで4行を追加
            for (let i = 0; i < 4; i++) {
                transactions.push({ price: 0, quantity: 0 });
            }

            // 初期描画
            renderTransactions();

            // イベントリスナー
            addRowBtn.addEventListener('click', addRow);
            longBtn.addEventListener('click', () => toggleType(true));
            shortBtn.addEventListener('click', () => toggleType(false));
            targetPriceInput.addEventListener('input', calculateProfitLoss);
            
            // 初期トグル状態を反映
            toggleType(true);
        }

        // ページロード時に初期化を実行
        window.onload = init;
    </script>
</body>
</html>
